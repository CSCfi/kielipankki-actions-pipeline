# Kielipankki GitHub Actions Pipeline

The contents of this repository handle the setup for GitHub Actions, including
both the runners and the templates for basic pipeline scripts.

## Setting up the Pipeline

### Create a Personal Access Token
To fetch the authorization token for creating new runners, we need a Personal
Access Token (PAT). One can be generated by navigating to GitHub and then
settings > developer settings > personal access tokens > generate new token.
The token only needs to have the `public_repo` scope, which means that it will
not expose anything about private repositories etc, but it does grant read and
write access to "code, commit statuses, repository projects, collaborators, and
deployment statuses for public repositories and organizations" (see
[docs](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)).

There must be a valid PAT in `runner-secrets`. To save the token there, write
the token into a file called `gh_runner_pat` and add it into the OC secrets
with the following command:
```
oc create secret generic runner-pat --from-file=gh_runner_pat
```

### Build the Container
```
docker build runner -t runner
```

### Upload the Container Image to Rahti
Before uploading you need to authenticate. Authentication command and token are
shown in the [container registry
UI](https://registry-console.rahti.csc.fi/registry#/?namespace=kielipankki-github-runners).
```
docker tag runner docker-registry.rahti.csc.fi/kielipankki-github-runners/runner:[VERSION]
docker push docker-registry.rahti.csc.fi/kielipankki-github-runners/runner:[VERSION]
```
You can check the previous version from [the container
registry](https://registry-console.rahti.csc.fi/registry#/?namespace=kielipankki-github-runners):
increment the major/minor/patch version depending on the changes made.

### Deploy the Runner as a Pod
First you must authenticate to OpenShift. The command and token for
authentication can be copied from [OpenShift console
UI](https://rahti.csc.fi:8443/console/catalog) by clicking your name on the
upper right corner and choosing "copy login command".

After that you can deploy a new pod with
```
oc create -f pod.yml
```
and you should now see a new runner in GitHub.

Remember to delete the old runner if need be.
